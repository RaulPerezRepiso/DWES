<?php

class ACLBD extends ACLBase
{

    private $_sqli;
    private $_hayConeccion;
    private $_prefijo = '_$"_';  //usado con algoritmo md5 como prefijo que se adjunta a la contraseña para darle mas seguridad



    public function __construct($servidor, $usuario, $contra, $bd)
    {
        $this->_hayConeccion = true;
        $this->_sqli = new mysqli($servidor, $usuario, $contra, $bd);
        if (!$this->_sqli || $this->_sqli->connect_errno <> 0)
            $this->_hayConeccion = false;
    }

    /**
     * Añade un role a nuesta ACL
     * 
     * @param string $nombre Nombre del role a añadir 
     * @param array $permisos Permisos que tendrá el role. Array con hasta 10 permisos
     * @return bool True si se ha podido crear, false en caso contrario
     */
    public function anadirRole(string $nombre, array $permisos = []): bool
    {
        if (!$this->_hayConeccion)
            return false;

        $nombre = mb_substr(mb_strtolower($nombre), 0, 30);

        if ($this->existeNombreRole($nombre))
            return false;

        for ($cont = 1; $cont <= 10; $cont++) {
            if (isset($permisos[$cont])) {
                $aPermisos[$cont] = isset($permisos[$cont]) && (bool)$permisos[$cont] ? '1' : '0';
            } else {
                $aPermisos[$cont] = '0';
            }
        }

        $nombre = $this->_sqli->escape_string($nombre);

        $sentencia = "insert into acl_roles (" .
            "     nombre, " .
            "    perm1, perm2,perm3,perm4,perm5," .
            "    perm6,perm7, perm8, perm9, perm10" .
            "       ) values (" .
            "     '$nombre', " .
            "    {$aPermisos[1]}, {$aPermisos[2]}," .
            "    {$aPermisos[3]},{$aPermisos[4]}," .
            "    {$aPermisos[5]}, {$aPermisos[6]}," .
            "    {$aPermisos[7]}, {$aPermisos[8]}," .
            "    {$aPermisos[9]}, {$aPermisos[10]}" .
            "          )";
        $resultado = $this->_sqli->query($sentencia);
        return $resultado == true;
    }


    /**
     * Funcion privada para comprobar que un role (nombre)
     * exite
     *
     * @param string $role role a comprobar
     * @return boolean devuelve true si existe, false en otro caso
     */
    private function existeNombreRole(string $role): bool
    {
        if (!$this->_hayConeccion)
            return false;

        $role = mb_substr(mb_strtolower($role), 0, 30);
        $role = $this->_sqli->escape_string($role);

        $sentencia = "select * from acl_roles where nombre='$role'";
        $resultado = $this->_sqli->query($sentencia);
        if (!$resultado)
            return false;

        $fila = $resultado->fetch_assoc();

        return ($fila != false);
    }

    /**
     * Función que localiza un role y devuelve el código de ese role o false si no
     * lo encuentra
     *
     * @param string $nick nick del usuario para encontrar el role asociado
     * @return integer|false Devuelve el código de role para el nombre indicado o false si no encuentra el role
     */
    public function getCodRole(string $nick): int|false
    {
        if (!$this->_hayConeccion)
            return false;

        $consulta = "SELECT cod_acl_role FROM acl_usuarios WHERE nick = '{$nick}'";

        $resul = $this->_sqli->query($consulta)->fetch_assoc();

        if (is_null($resul))
            return false;

        return true;
    }

    /**
     * Función que comprueba la existencia de un role
     *
     * @param integer $codRole role a buscar
     * @return boolean Devuelve true si lo encuentra o false en caso contrario 
     */
    public function existeRole(int $codRole): bool
    {
        if (!$this->_hayConeccion)
            return false;


        $consulta = "SELECT * from acl_roles " .
            "      where cod_acl_role = $codRole";

        $resul = $this->_sqli->query($consulta)->fetch_assoc();

        if (is_null($resul))
            return false;

        return true;
    }

    /**
     * Función que devuelve los permisos de un role dado
     *
     * @param integer $codRole Role a buscar
     * @return array|false Devuelve los permisos o false si no encuentra el role
     */
    public function getPermisosRole(int $codRole): array|false
    {
        if (!$this->_hayConeccion)
            return false;

        if (!$this->existeRole($codRole))
            return false;


        $consulta = "SELECT `perm1`, `perm2`, `perm3`, `perm4`, `perm5`," .
            "      `perm6`, `perm7`, `perm8`, `perm9`, `perm10` " .
            "     FROM `acl_roles` " .
            "     WHERE cod_acl_role = $codRole";


        $resul = $this->_sqli->query($consulta)->fetch_row();
        $perm = [];
        for ($cont = 1; $cont < 11; $cont++)
            $perm[$cont] = (bool)$resul[$cont - 1];

        return ($perm);
    }

    /**
     * Función que devuelve si un role tiene o no un permiso concreto
     *
     * @param integer $codRole Role a buscar
     * @param integer $numero Número de permiso
     * @return boolean True si encuentra el role y lo tiene. False en cualquier otro caso
     */
    function getPermisoRole(int $codRole, int $numero): bool
    {
        if (!$this->_hayConeccion)
            return false;

        if (!$this->existeRole($codRole))
            return false;

        $consulta = "SELECT * from acl_usuarios
                         where cod_acl_role = $codRole";

        $resul = $this->_sqli->query($consulta)->fetch_assoc();

        if (is_null($resul))
            return false;

        if ($resul["perm" . $numero] != 1)
            return false;

        return true;
    }

    /**
     * Función que añade un nuevo usuario a nuestra ACL
     *
     * @param string $nombre Nombre del usuario
     * @param string $nick Nick unico para el usuario
     * @param string $contrasena contraseña del usuario
     * @param integer $codRole Role a asignarle
     * @return boolean Devuelve true si puede crearlo. False en caso contrario
     */
    public function anadirUsuario(string $nombre, string $nick, string $contrasena, int $codRole): bool
    {
        if (!$this->_hayConeccion)
            return false;

        if (!$this->existeRole($codRole))
            return false;

        $nick = mb_strtolower($nick);

        if ($this->existeUsuario($nick))
            return false;

        $nombre = $this->_sqli->escape_string(mb_substr($nombre, 0, 50));
        $nick = $this->_sqli->escape_string(mb_substr($nick, 0, 50));

        //usando md5
        //$contrasena=md5($this->_prefijo.$contrasena);

        //usando sha1
        $contrasena = mb_substr(sha1($contrasena), 0, 64);

        //usando blowfish
        //$contrasena= password_hash($contrasena, PASSWORD_BCRYPT);

        $consulta = "INSERT INTO  acl_usuarios (" .
            " nick,nombre,contrasenia,cod_acl_role,borrado" .
            "    ) VALUES (" .
            "'$nick', '$nombre', '$contrasena', $codRole,false)";
        return $this->_sqli->query($consulta);
    }

    /**
     * Obtiene el código de usuario para un nick dado
     *
     * @param string $nick nick del usuario a buscar
     * @return integer|false Devuelve el codigo del usuario o false si no lo encuentra
     */
    function getCodUsuario(string $nick): int|false
    {
        if (!$this->_hayConeccion)
            return false;

        $nick = mb_strtolower($nick);
        $nick = $this->_sqli->escape_string(mb_substr($nick, 0, 50));

        $consulta = "SELECT cod_acl_usuario FROM acl_usuarios " .
            "        WHERE nick = '$nick'";

        $resul = $this->_sqli->query($consulta)->fetch_assoc();

        return (is_null($resul) ? false : intval($resul["cod_acl_usuario"]));
    }